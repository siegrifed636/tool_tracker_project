{% extends 'tracker/base.html' %}
{% load static %}

{% block title %}Lab Maintenance{% endblock %}

{% block content %}
<h2 class="mb-4">Tool Sedang Diperbaiki</h2>
<div class="card shadow mb-5">
    <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">Daftar Tool Aktif di Lab</h6>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-bordered table-striped" width="100%" cellspacing="0">
                <thead>
                    <tr>
                        <th>Tgl. Masuk</th>
                        <th>ID Tool</th>
                        <th>Tipe Tool</th>
                        <th>No. Seri</th>
                        <th>Proses (Awal)</th>
                        <th>Stasiun (Awal)</th>
                        <th>Kerusakan</th>
                        <th>Part Digunakan</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody>
                    {% for repair in active_repairs %}
                    <tr>
                        <td>{{ repair.waktu_masuk|date:"d M Y, H:i" }}</td>
                        <td>{{ repair.id_tool_snapshot|default:repair.tool.id_tool }}</td>
                        <td>{{ repair.tipe_tool_snapshot|default:repair.tool.tipe_tool }}</td>
                        <td>{{ repair.nomor_seri_snapshot|default:repair.tool.nomor_seri }}</td>
                        <td>{{ repair.proses_awal_snapshot|default:"-" }}</td>
                        <td>{{ repair.stasiun_snapshot|default:"-" }}</td>
                        <td>{{ repair.jenis_kerusakan|default:"<span class='text-muted'>Belum didiagnosa</span>"|safe }}</td>
                        <td>{{ repair.part_yang_digunakan|default:"<span class='text-muted'>-</span>"|safe }}</td>
                        <td style="min-width: 280px;">
                            {% if user.userprofile.is_developer or user.userprofile.can_edit_lab %}
                                <a href="{% url 'update_diagnosa' repair.id %}" class="btn btn-sm btn-warning mb-1">
                                    Isi Diagnosa
                                </a>
                                <a href="{% url 'finish_repair' repair.tool.id %}" class="btn btn-sm btn-success mb-1">
                                    Selesaikan
                                </a>
                                <form action="{% url 'simpan_di_gudang' repair.tool.id %}" method="post" class="d-inline ms-1">
                                    {% csrf_token %}
                                    <button type,"submit" class="btn btn-sm btn-secondary mb-1" 
                                            onclick="return confirm('Anda yakin ingin memindahkan tool {{ repair.tool.id_tool }} ke Gudang TPM?')">
                                        Ke Gudang
                                    </button>
                                </form>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="9" class="text-center">Tidak ada tool yang sedang diperbaiki saat ini.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<h2 class="mb-4">Riwayat Perbaikan Selesai</h2>
<div class="card shadow mb-4">
    <div class="card-header py-3 d-flex flex-wrap justify-content-between align-items-center">
        <h6 class="m-0 font-weight-bold text-primary">Riwayat Perbaikan Selesai</h6>
        <a href="{% url 'download_laporan_lab' %}" class="btn btn-success btn-sm mt-2 mt-md-0">
            <i class="fas fa-file-excel"></i> Download Riwayat
        </a>
    </div>
    <div class="card-body">
        <form method="get" class="row mb-3">
            <div class="col-md-3">
                <label for="id_year" class="form-label">Tahun:</label>
                <select name="year" id="id_year" class="form-select">
                    <option value="">Semua Tahun</option>
                    {% for year in years_with_history %}
                        <option value="{{ year }}" {% if year == selected_year %}selected{% endif %}>{{ year }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label for="id_month" class="form-label">Bulan:</label>
                <select name="month" id="id_month" class="form-select">
                    <option value="">Semua Bulan</option>
                    {% for month in months %}
                        <option value="{{ month.value }}" {% if month.value == selected_month %}selected{% endif %}>{{ month.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3 align-self-end">
                <button type="submit" class="btn btn-primary">Filter</button>
                <a href="{% url 'lab_maintenance_list' %}" class="btn btn-secondary">Reset</a>
            </div>
        </form>

        <div class="table-responsive">
            <table class="table table-bordered table-sm" width="100%" cellspacing="0">
                <thead>
                    <tr>
                        <th>ID Tool</th>
                        <th>Tipe Tool</th>
                        <th>No. Seri</th>
                        <th>Stasiun (Awal)</th>
                        <th>Kerusakan</th>
                        <th>Part Digunakan</th>
                        <th>Proses (Tujuan)</th>
                        <th>Tgl Masuk</th>
                        <th>Waktu Masuk</th>
                        <th>Tgl Selesai</th>
                        <th>Waktu Selesai</th>
                        <th>Oleh</th>
                    </tr>
                </thead>
                <tbody>
                    {% for log in history_list %}
                    <tr>
                        <td>{{ log.id_tool_snapshot|default:"-" }}</td>
                        <td>{{ log.tipe_tool_snapshot|default:"-" }}</td>
                        <td>{{ log.nomor_seri_snapshot|default:"-" }}</td>
                        <td>{{ log.stasiun_snapshot|default:"-" }}</td>
                        <td>{{ log.jenis_kerusakan|default:"-" }}</td>
                        <td>{{ log.part_yang_digunakan|default:"-" }}</td>
                        <td>{{ log.proses_tujuan_snapshot|default:"-" }}</td>
                        <td>{{ log.waktu_masuk|date:"d M Y" }}</td>
                        <td>{{ log.waktu_masuk|date:"H:i" }}</td>
                        <td>{{ log.waktu_selesai|date:"d M Y" }}</td>
                        <td>{{ log.waktu_selesai|date:"H:i" }}</td>
                        <td>{{ log.dikerjakan_oleh|default:"-" }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="12" class="text-center">Tidak ada riwayat untuk filter ini.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

{% endblock %}