<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% block title %}Tool Tracker App{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <style>
        body { display: flex; }
        .sidebar { width: 280px; min-height: 100vh; background-color: #212529; }
        .sidebar .nav-link { color: rgba(255, 255, 255, 0.75); padding: 0.75rem 1.5rem; border-radius: 0.375rem; display: flex; align-items: center; }
        .sidebar .nav-link:hover, .sidebar .nav-link.active { color: #fff; background-color: #343a40; }
        .sidebar .app-title { padding: 1.25rem 1.5rem; border-bottom: 1px solid #495057; font-size: 1.25rem; font-weight: bold; }
        .sidebar .user-info { padding: 1rem 1.5rem; border-bottom: 1px solid #495057; }
        .sidebar .footer-info { margin-top: auto; padding: 1rem 1.5rem; font-size: 0.9rem; color: rgba(255, 255, 255, 0.5); }
        .main-content { flex-grow: 1; background-color: #f8f9fa; }
        .topbar { background-color: #fff; border-bottom: 1px solid #dee2e6; padding: 0.75rem 1.5rem; }
    </style>
</head>
<body>
    <div class="sidebar d-flex flex-column text-white">
        <div class="app-title">
            <i class="bi bi-tools me-2"></i> Tool Tracking System
        </div>
        
        <div class="user-info">
            {% if user.is_authenticated %}
                <div class="small">Selamat Datang,</div>
                <div class="fw-bold mb-2">{{ user.userprofile.nama_lengkap|default:user.username }}</div>
                <form action="{% url 'logout' %}" method="post" class="d-grid">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-sm btn-outline-light">Logout</button>
                </form>
            {% else %}
                <div class="d-grid gap-2">
                    <a href="{% url 'login' %}" class="btn btn-primary">Login</a>
                    <a href="{% url 'register' %}" class="btn btn-secondary">Daftar</a>
                </div>
            {% endif %}
        </div>

        <ul class="nav flex-column p-2">
            {% if user.userprofile.is_developer or user.userprofile.can_view_proses %}
            <li class="nav-item"><a class="nav-link" href="{% url 'daftar_proses' %}"><i class="bi bi-diagram-3-fill me-2"></i> Proses</a></li>
            {% endif %}
            {% if user.userprofile.is_developer or user.userprofile.can_view_lab %}
            <li class="nav-item"><a class="nav-link" href="{% url 'lab_maintenance_list' %}"><i class="bi bi-heart-pulse-fill me-2"></i> Lab Maintenance</a></li>
            {% endif %}
            {% if user.userprofile.is_developer or user.userprofile.can_view_stok %}
            <li class="nav-item"><a class="nav-link" href="{% url 'manajemen_stok' %}"><i class="bi bi-box-seam-fill me-2"></i> Stok Suku Cadang</a></li>
            {% endif %}
            {% if user.userprofile.is_developer or user.userprofile.can_view_laporan %}
            <li class="nav-item"><a class="nav-link" href="{% url 'halaman_laporan' %}"><i class="bi bi-pie-chart-fill me-2"></i> Laporan</a></li>
            {% endif %}
            {% if user.userprofile.is_developer or user.userprofile.can_view_produksi %}
            <li class="nav-item"><a class="nav-link" href="{% url 'halaman_produksi' %}"><i class="bi bi-clipboard-data-fill me-2"></i> Target Produksi</a></li>
            {% endif %}
            {% if user.userprofile.is_developer %}
            <li class="nav-item"><a class="nav-link" href="{% url 'hak_akses_list' %}"><i class="bi bi-person-fill-gear me-2"></i> Manajemen Akses</a></li>
            {% endif %}
        </ul>
        
        <div class="footer-info">
            <div id="live-clock" class="fw-bold text-center mb-1"></div>
            <div class="text-center">Status: <span id="app-status-badge" class="badge">Loading...</span></div>
        </div>
    </div>

    <div class="main-content">
        <div class="topbar">
            </div>
        <div class="container-fluid p-4">
            {% if messages %}
                {% for message in messages %}
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                {% endfor %}
            {% endif %}
            {% block content %}{% endblock %}
        </div>
    </div>
    
    <div class="modal fade" id="historyModal" tabindex="-1" aria-labelledby="historyModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header"><h5 class="modal-title" id="historyModalLabel">Riwayat Perbaikan untuk Tool: </h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div>
          <div class="modal-body" id="historyModalBody"><p>Memuat riwayat...</p></div>
        </div>
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    {% block scripts %}{% endblock %}
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const statusBadge = document.getElementById('app-status-badge');
            function updateStatus() {
                const holidays = ['2025-01-01', '2025-03-31', '2025-04-01', '2025-05-01', '2025-08-17', '2025-12-25'];
                const now = new Date();
                const today = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0') + '-' + String(now.getDate()).padStart(2, '0');
                const day = now.getDay();
                const currentTime = now.getHours() * 60 + now.getMinutes();
                let lunchStart, lunchEnd;
                const month = now.getMonth() + 1;
                if (month === 10) { lunchStart = 12 * 60 + 20; lunchEnd = lunchStart + 40; } 
                else { lunchStart = 12 * 60; lunchEnd = lunchStart + 40; }
                const workStart = 7 * 60 + 30;
                const workEnd = 16 * 60 + 30;
                const break1Start = 10 * 60;
                const break1End = break1Start + 5;
                const break2Start = 15 * 60;
                const break2End = break2Start + 5;
                let statusText = 'Off Time';
                let statusClass = 'badge bg-danger';
                const isHoliday = holidays.includes(today);
                const isWeekend = (day === 0 || day === 6);
                if (!isHoliday && !isWeekend) {
                    if (currentTime >= workStart && currentTime < workEnd) {
                        if (currentTime >= break1Start && currentTime < break1End) { statusText = 'Break Time'; statusClass = 'badge bg-warning text-dark'; } 
                        else if (currentTime >= lunchStart && currentTime < lunchEnd) { statusText = 'Break Time'; statusClass = 'badge bg-warning text-dark'; } 
                        else if (currentTime >= break2Start && currentTime < break2End) { statusText = 'Break Time'; statusClass = 'badge bg-warning text-dark'; } 
                        else { statusText = 'On Time'; statusClass = 'badge bg-success'; }
                    }
                }
                if (statusBadge) { statusBadge.textContent = statusText; statusBadge.className = statusClass; }
            }
            
            const clockElement = document.getElementById('live-clock');
            function updateClock() {
                const now = new Date();
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                const seconds = String(now.getSeconds()).padStart(2, '0');
                if (clockElement) { clockElement.textContent = `${hours}:${minutes}:${seconds}`; }
            }
            if (clockElement) { updateClock(); setInterval(updateClock, 1000); }
            if (statusBadge) { updateStatus(); setInterval(updateStatus, 60000); }
            const historyModal = document.getElementById('historyModal');
            if (historyModal) {
                historyModal.addEventListener('show.bs.modal', function (event) {
                    const button = event.relatedTarget;
                    const toolId = button.getAttribute('data-tool-id');
                    const toolName = button.getAttribute('data-tool-name');
                    const modalTitle = historyModal.querySelector('.modal-title');
                    const modalBody = historyModal.querySelector('#historyModalBody');
                    modalTitle.textContent = 'Riwayat Perbaikan untuk Tool: ' + toolName;
                    modalBody.innerHTML = '<p>Memuat riwayat...</p>';
                    fetch(`/tool/${toolId}/history/`)
                        .then(response => response.json())
                        .then(data => {
                            let content = '<table class="table table-sm"><thead><tr><th>Waktu</th><th>Kerusakan</th><th>Part Digunakan</th><th>Oleh</th></tr></thead><tbody>';
                            if (data.history.length > 0) {
                                data.history.forEach(item => {
                                    content += `<tr><td>${item.waktu_selesai}</td><td>${item.jenis_kerusakan}</td><td>${item.part_yang_digunakan}</td><td>${item.dikerjakan_oleh}</td></tr>`;
                                });
                            } else {
                                content += '<tr><td colspan="4" class="text-center">Tidak ada riwayat perbaikan.</td></tr>';
                            }
                            content += '</tbody></table>';
                            modalBody.innerHTML = content;
                        });
                });
            }
        });
    </script>
</body>
</html>